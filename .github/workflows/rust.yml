name: Rust

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/rust.yml'

env:
  CARGO_TERM_COLOR: always

# 需要推 tag + 发 Release
permissions:
  contents: write

jobs:
  # —————————————————— 1️⃣  Build —————————————————— #
  build:
    name: Build (${{ matrix.artifact_name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # —— Windows x64 —— #
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: windows-x86_64

          # —— Windows ARM64 —— #
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            artifact_name: windows-aarch64

          # —— Linux x64 —— #
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux-x86_64

          # —— Linux ARM64 —— #
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_name: linux-aarch64

          # —— macOS x86_64 —— #
          - os: macos-15-intel
            target: x86_64-apple-darwin
            artifact_name: macos-x86_64

          # —— macOS ARM64 —— #
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: macos-aarch64

    steps:
      - uses: actions/checkout@v4

      # 安装 stable Rust
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linux 依赖：glib-sys 需要 glib-2.0.pc（libglib2.0-dev）+ pkg-config
      - name: Install Linux deps (glib)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libglib2.0-dev zip

      # Release 构建
      - name: Cargo build
        run: cargo build --release --target ${{ matrix.target }}

      # —— 打包：Linux/macOS 用 zip —— #
      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          rel="target/${{ matrix.target }}/release"

          shopt -s nullglob
          files=()
          # 主二进制（按你原来的命名）
          files+=("$rel/panorama_viewer")
          # 可能存在的动态库/静态库
          files+=("$rel/"*.so "$rel/"*.dylib "$rel/"*.a "$rel/"*.rlib "$rel/"*.lib)

          # 过滤掉不存在的（nullglob 已处理，但 panorama_viewer 可能缺失则这里显式判断）
          if [ ! -f "$rel/panorama_viewer" ]; then
            echo "ERROR: expected binary not found: $rel/panorama_viewer"
            ls -la "$rel" || true
            exit 1
          fi

          zip -j "dist/${{ matrix.artifact_name }}.zip" "${files[@]}"

      # —— 打包：Windows 用 Compress-Archive —— #
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          $rel = "target\${{ matrix.target }}\release"

          $bin = Join-Path $rel "panorama_viewer.exe"
          if (!(Test-Path $bin)) {
            Write-Host "ERROR: expected binary not found: $bin"
            Get-ChildItem -Force $rel | Format-Table -AutoSize
            exit 1
          }

          $files = @()
          $files += $bin

          # 常见库文件（存在就打包）
          $patterns = @("*.dll","*.lib","*.pdb")
          foreach ($p in $patterns) {
            $items = Get-ChildItem -Path $rel -Filter $p -File -ErrorAction SilentlyContinue
            if ($items) { $files += $items.FullName }
          }

          $zipPath = "dist\${{ matrix.artifact_name }}.zip"
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path $files -DestinationPath $zipPath -Force

      # 上传产物供后续 Release 使用
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}.zip
          retention-days: 30

  # —————————————————— 2️⃣  Release —————————————————— #
  release:
    name: Tag & Release
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1) 下载所有产物
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 2) 生成 vYYYY-MM-DD
      - name: Set release date
        id: date
        run: |
          echo "RELEASE_DATE=$(date -u +'%Y-%m-%d')" >>"$GITHUB_OUTPUT"

      # 3) 创建并推送 tag（若已存在则跳过创建）
      - name: Create & push tag (if missing)
        env:
          TAG_NAME: v${{ steps.date.outputs.RELEASE_DATE }}
        run: |
          set -euo pipefail
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"

          git fetch --tags
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping tag creation."
          else
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

      # 4) 建 Release 并上传全部产物
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.RELEASE_DATE }}
          name: Release v${{ steps.date.outputs.RELEASE_DATE }}
          body: |
            **自动发布**
            - 基于 commit `${{ github.sha }}`
            - 生成时间 (UTC)：${{ steps.date.outputs.RELEASE_DATE }}
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
