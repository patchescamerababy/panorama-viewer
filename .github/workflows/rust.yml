name: Rust

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/rust.yml'

env:
  CARGO_TERM_COLOR: always
  APP_NAME: panorama_viewer

permissions:
  contents: write

jobs:
  # —————————————————— 1️⃣  Build —————————————————— #
  build:
    name: Build (${{ matrix.artifact_name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # —— Windows x64 —— #
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: windows-x86_64

          # —— Windows ARM64 —— #
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            artifact_name: windows-aarch64

          # —— Linux x64 —— #
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux-x86_64

          # —— Linux ARM64 —— #
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_name: linux-aarch64

          # —— macOS x86_64 —— #
          - os: macos-15-intel
            target: x86_64-apple-darwin
            artifact_name: macos-x86_64

          # —— macOS ARM64 —— #
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: macos-aarch64

    steps:
      - uses: actions/checkout@v4

      # 安装 stable Rust + 目标
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linux 依赖：glib-sys/atk-sys 等需要 pkg-config + *.pc
      # 说明：
      # - libglib2.0-dev -> glib-2.0.pc
      # - libatk1.0-dev  -> atk.pc   （你现在报错缺这个）
      # 如果你用 gtk-rs（GTK3），强烈建议把 pango/cairo/gtk 也装上，避免继续报缺库。
      - name: Install Linux deps (glib/atk/gtk stack)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config zip \
            libglib2.0-dev \
            libatk1.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libgtk-3-dev

      # Release 构建
      - name: Cargo build
        run: cargo build --release --target ${{ matrix.target }}

      # —— 打包：Linux/macOS 用 zip —— #
      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          rel="target/${{ matrix.target }}/release"

          bin="$rel/${APP_NAME}"
          if [ ! -f "$bin" ]; then
            echo "ERROR: expected binary not found: $bin"
            ls -la "$rel" || true
            exit 1
          fi

          shopt -s nullglob
          files=("$bin")
          files+=("$rel/"*.so "$rel/"*.dylib "$rel/"*.a "$rel/"*.rlib "$rel/"*.lib)

          zip -j "dist/${APP_NAME}-${{ matrix.artifact_name }}.zip" "${files[@]}"

      # —— 打包：Windows 用 Compress-Archive —— #
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          $rel = "target\${{ matrix.target }}\release"

          $bin = Join-Path $rel "${env:APP_NAME}.exe"
          if (!(Test-Path $bin)) {
            Write-Host "ERROR: expected binary not found: $bin"
            Get-ChildItem -Force $rel | Format-Table -AutoSize
            exit 1
          }

          $files = @()
          $files += $bin

          # 常见附加文件（存在就打包）
          $patterns = @("*.dll","*.lib","*.pdb")
          foreach ($p in $patterns) {
            $items = Get-ChildItem -Path $rel -Filter $p -File -ErrorAction SilentlyContinue
            if ($items) { $files += $items.FullName }
          }

          $zipPath = "dist\${env:APP_NAME}-${{ matrix.artifact_name }}.zip"
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path $files -DestinationPath $zipPath -Force

      # ✅ 上传：artifact 名称、文件名、路径三者一致
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.artifact_name }}
          path: dist/${{ env.APP_NAME }}-${{ matrix.artifact_name }}.zip
          retention-days: 30

  # —————————————————— 2️⃣  Release —————————————————— #
  release:
    name: Tag & Release
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set release date
        id: date
        run: |
          echo "RELEASE_DATE=$(date -u +'%Y-%m-%d')" >>"$GITHUB_OUTPUT"

      - name: Create & push tag (if missing)
        env:
          TAG_NAME: v${{ steps.date.outputs.RELEASE_DATE }}
        run: |
          set -euo pipefail
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name  "github-actions[bot]"
          git fetch --tags
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping."
          else
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.RELEASE_DATE }}
          name: Release v${{ steps.date.outputs.RELEASE_DATE }}
          body: |
            **自动发布**
            - 基于 commit `${{ github.sha }}`
            - 生成时间 (UTC)：${{ steps.date.outputs.RELEASE_DATE }}
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
